---
title: "Competitive Youth Soccer in the D.C. Metropolitan Area"
author: "Tyler Richardett"
date: "10/22/2017"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = TRUE)

Sys.setlocale(locale="en_us.UTF-8")

theme_TCR <- function() {
        theme_bw(base_size = 12, base_family = "Avenir") %+replace% 
                theme(
                        panel.border = element_blank(),
                        axis.line.x = element_line(color = "#222222", size = 0.5),
                        axis.ticks.y = element_blank(),
                        axis.text = element_text(color = "#222222", size = 11),
                        panel.grid.major.x = element_blank(),
                        panel.grid.major.y = element_line(linetype = "dotted", 
                                                          color = "grey"),
                        panel.grid.minor = element_blank(),
                        plot.title = element_text(face = "bold", size = 16),
                        axis.title.x = element_text(margin = margin(15,0,0,0)),
                        axis.title.y = element_text(margin = margin(0,15,0,0), angle = 90),
                        legend.position = "bottom",
                        legend.title = element_blank(),
                        legend.direction = "horizontal",
                        legend.box = "horizontal",
                        legend.key.size = unit(8, "pt")
                ) 
}
```

## Overview

In the wake of the U.S. men's national soccer team failing to [qualify](https://www.washingtonpost.com/news/soccer-insider/wp/2017/10/10/in-a-stunner-u-s-falls-to-trinidad-and-tobago-and-will-not-qualify-for-2018-world-cup/?utm_term=.a5877dd1a765) for the 2018 FIFA World Cup, an unimaginable series of events left supporters, former players, and members of the media trying to make sense of it all. Some responses were [measured](http://www.espnfc.com/team/united-states/660/blog/post/3227056/why-the-us-failed-to-qualify-for-2018-world-cup-in-russia)â€”others [impassioned](http://www.espnfc.com/world-cup-qualifying-concacaf/64/video/3226307), delivered in the heat of the moment. But most shared a common thread: frustration with the country's youth development system. 

More specifically, there emerged a collective assault on "[pay-to-play](https://www.theguardian.com/football/blog/2016/jun/01/us-soccer-diversity-problem-world-football)," a structure which, some argue, limits access for low-income children of color to high-quality, competitive soccer. Building off that argument, I decided to study two lesser-discussed, yet closely related, pieces of the puzzle: location and exposure.

A Washington, D.C.-area resident, I decided to limit my sample to this area. The clubs participating in the National Capital Soccer League's Fall 2017 season set the geographic limits of my study (D.C. and the surrounding counties in northern Virginia, southern Maryland, and eastern West Virginia). Based on this information, I collected field addresses to calculate the mean location of each club, and I collected race and poverty data for each census tract in the region from the U.S. Census Bureau's 2015 [American Community Survey](https://www.census.gov/programs-surveys/acs/) (ACS).

Most notably, the opportunities to play competitive soccer for children in mostly nonwhite neighborhoods are few and far between. When plotting the points on the map (see the **Race** section below), a 20-plus-mile-wide hole opened up in the area southeast of D.C., where a majority of the census tracts in which the share of nonwhite residents is 60 percent or greater. And out of the 380 soccer fields in the sample, less than 15 percent are located in majority-minority census tracts. (For reference, out of the 1,600 census tracts in the sample, 32 percent are majority-minority.)

Socioeconomic diversity (by way of poverty rates) also played a role, though less prominent. Out of the 380 soccer fields in the sample, *just one* is located in a census tract with a poverty rate greater than 20 percent. (For reference, out of the 1,600 census tracts in the sample, 15 percent have poverty rates greater than 20 percent.)

I did attempt a handful of different regression techniques in an attempt to explain causality within the sample. But the shape of the data (only 177 of the 1,600 census tracts contained at least one field) prevented both the nonwhite share and poverty rate of a census tract from being accurate or reliable predictors of the presence of a soccer field on which competitive games are played.

While no conclusions about the state of U.S. youth soccer should be drawn from this study, it does reveal some interesting, albeit alarming, trends within the region of our nation's capital. 

This is not to say that children growing up in these underserved areas are stripped of *all* opportunities to enjoy the beautiful game. Organizations like [DC SCORES](https://www.dcscores.org/) and the [U.S. Soccer Foundation](https://ussoccerfoundation.org/programs/safe-places-to-play) work to ensure that they are not completely excluded. But if the stated goal of the soccer community is to develop a more racially and socioeconomically diverse pipeline through the ranks of our senior U.S. national teams, these findings may suggest that there's still work to be done.

## Data Collection

Most youth clubs in the D.C. metropolitan area have at least one team in the [National Capital Soccer League](http://www.ncsl-soccer.com/) (NCSL). With the help of the `{rvest}` package, I began by scraping the names of each club from their listings webpage.

*Note: Freedom Soccer Club was removed from this list, as it moved to the Central Maryland Soccer Association prior to the Fall 2017 season. I allowed the reach of the remaining National Capital Soccer League clubs to set the geographic boundaries for this project. Then, other clubs from the states of Maryland and Virginia which participate in other leagues (e.g., Virginia Premier League, Club Champions League, Central Maryland Soccer Association), but which still fell within those geographic boundaries, were manually added to the data set.*

```{r scrape.clubnames}
library(rvest)
library(dplyr)

ncsl <- read_html("http://www.ncsl-soccer.com/Clubs/index_E.html?1508373282")

clubs <- ncsl %>%
        html_node("#cb-list-tbl-1") %>%
        html_table(fill = TRUE)
clubs <- data.frame(club.name = c(clubs$X1, clubs$X2, clubs$X3))
clubs <- data.frame(club.name = sort(clubs$club.name))
clubs$club.name <- as.character(clubs$club.name)
clubs <- filter(clubs, club.name != "Freedom Soccer Club")
```

NCSL's website was very outdated--built with many nested tables and *without* the use of many classes or ids. Building a scraping function that accounted for all its quirks required a fair amount of trial and error. Using nested `for` loops and functions from the `{rvest}` pacakge, I navigated through the hierarchy of each club webpage and built a data frame containing the names and addresses of each soccer field, along with its corresponding club.

```{r scrape.fieldinfo}
## Set session of list of all clubs
sessionTmp <- html_session("http://www.ncsl-soccer.com/Clubs/index_E.html?1508373282")

## Empty data frame to put fields and addresses
fields.df <- data.frame()

## Clubs with both boys and girls teams
for (i in c(1, 3:8, 10:15, 17:20, 22:26, 28:29, 31:33, 35:54, 56:65, 67:68, 71:72)) {
        clubsessionTmp <- sessionTmp %>% follow_link(clubs[i,1])
        
        listTmp <- clubsessionTmp %>% 
                                    html_nodes("div.ww-elements-display table.MainContent td table") %>% 
                                    .[[6]] %>% 
                                    html_nodes("a") %>% 
                                    html_text(trim = TRUE)
        
        listTmp <- data.frame(club.name = rep(clubs[i,1], length(listTmp)), field.name = listTmp)
        listTmp$club.name <- as.character(listTmp$club.name)
        listTmp$field.name <- as.character(listTmp$field.name)
        
        for (p in 1:length(listTmp$field.name)) {
                fieldTmp <- clubsessionTmp %>% 
                                             follow_link(listTmp[p,2]) %>% 
                                             html_nodes("table.MainContent table table b") %>%
                                             .[[1]] %>% 
                                             html_text(trim = TRUE)
                
                listTmp$field.address[p] <- fieldTmp
        }
        
        fields.df <- rbind(fields.df, listTmp)
}

## Clubs with teams of only one gender
for (i in c(2, 21, 27, 30, 34, 55, 66, 69:70)) {
        clubsessionTmp <- sessionTmp %>% follow_link(clubs[i,1])
        
        listTmp <- clubsessionTmp %>% 
                                    html_nodes("div.ww-elements-display table.MainContent td table") %>% 
                                    .[[5]] %>% 
                                    html_nodes("a") %>% 
                                    html_text(trim = TRUE)
        
        listTmp <- data.frame(club.name = rep(clubs[i,1], length(listTmp)), field.name = listTmp)
        listTmp$club.name <- as.character(listTmp$club.name)
        listTmp$field.name <- as.character(listTmp$field.name)
        
        for (p in 1:length(listTmp$field.name)) {
                fieldTmp <- clubsessionTmp %>% 
                                             follow_link(listTmp[p,2]) %>% 
                                             html_nodes("table.MainContent table table b") %>%
                                             .[[1]] %>% 
                                             html_text(trim = TRUE)
                
                listTmp$field.address[p] <- fieldTmp
        }
        
        fields.df <- rbind(fields.df, listTmp)
}
```

The above code was successful in capturing information for all but two clubs. (Both contained a Unicode character.) I captured the first club's information by making a small tweak to the previous function, and for the second, by inputting the information manually.

```{r scrape.fieldinfo.misc}
## Barca Futebol Club
clubsessionTmp <- html_session("http://www.ncsl-soccer.com/teams/club/15599476.html")

listTmp <- clubsessionTmp %>% 
                            html_nodes("div.ww-elements-display table.MainContent td table") %>% 
                            .[[5]] %>% 
                            html_nodes("a") %>% 
                            html_text(trim = TRUE)

listTmp <- data.frame(club.name = rep(clubs[9,1], length(listTmp)), field.name = listTmp)
listTmp$club.name <- as.character(listTmp$club.name)
listTmp$field.name <- as.character(listTmp$field.name)

for (p in 1:length(listTmp$field.name)) {
        fieldTmp <- clubsessionTmp %>% 
                                     follow_link(listTmp[p,2]) %>% 
                                     html_nodes("table.MainContent table table b") %>%
                                     .[[1]] %>% 
                                     html_text(trim = TRUE)
        
        listTmp$field.address[p] <- fieldTmp
}

fields.df <- rbind(fields.df, listTmp)

## Capital FC
capFC <- data.frame(club.name = rep("CapitalFC", 2), 
                    field.name = c("Randall Recreation Center #1 Full", 
                                   "Watkins Elementary School - DC #1"), 
                    field.address = c("25 I Street SW, Washington, DC 20024", 
                                      "420 12th Street Southeast, Washington, DC 20003"))

fields.df <- rbind(fields.df, capFC)
```

Next, I cleaned up the messy field addresses.

```{r clean.fieldinfo}
## Replace double spaces between street address and city names with a comma
fields.df$field.address <- gsub("\\s\\s", ", ", fields.df$field.address)

## Clean messy addresses
fields.df[10,3] <- "400 Hoofs Run Drive, Alexandria, VA 22314"
fields.df[c(11:12),3] <- "426 East Monroe Ave, Alexandria, VA 22301"
fields.df[c(67:68),3] <- "699 College Parkway, Annapolis, MD 21409"
fields.df[c(76:78),3] <- "4755 Hallowing Point Rd, Prince Frederick, MD 20678"
fields.df[c(99:101,371:374),3] <- "16332 Cyclone Way, Culpeper, VA 22701"
fields.df[c(111,430),3] <- "3825 Wisconsin Ave NW, Washington, DC 20016"
fields.df[114,3] <- "675 University Dr, Shepherdstown, WV 25443"
fields.df[121,3] <- "3300 Stafford Dr, Fairfax, VA 22030"
fields.df[c(122:123),3] <- "1730 N Market St, Frederick, MD 21701"
fields.df[c(129:130,189,368:370,422),3] <- "7700 Bull Run Dr, Centreville, VA 20121"
fields.df[c(155:161),3] <- "1085 Utterback Store Rd, Great Falls, VA 22066"
fields.df[210,3] <- "935 Spa Rd, Annapolis, MD 21401"
fields.df[c(289,290),3] <- "13001 Chinn Park Dr, Woodbridge, VA 22192"
fields.df[c(298,299),3] <- "1400 Lake Fairfax Dr, Reston, VA 20190"
fields.df[358,3] <- "6815 Edsall Road, Springfield, VA 22151"
fields.df[364,3] <- "499 Campus Drive, Martinsburg, WV 25404"
fields.df[376,3] <- "7575 Rogues Rd, Nokesville, VA 20181"
fields.df[c(377,423),3] <- "1460 University Dr, Winchester, VA 22601"
fields.df[381,3] <- "2500 James Madison Dr, Vienna, VA 22181"
fields.df[384,3] <- "7731 Leesburg Pike, Falls Church, VA 22043"
fields.df[c(403:407),3] <- "255 Lakeview Cir, Stephens City, VA 22655"
fields.df[431,3] <- "300 Van Buren St NW, Washington, DC 20012"
fields.df[433,3] <- "3401 Woodburn Rd, Annandale, VA 22003"
```

After scouring the web, I identified the non-NCSL teams located within the geographic boundaries and manually added their information to the data frame.

```{r input.otherclubs}
## FC Virginia United
fcv.united <- data.frame(club.name = rep("FC Virginia United", 6), 
                         field.name = c("Bles Park #1", "Bles Park #2", 
                                        "Evergreen Sportsplex #1", 
                                        "Evergreen Sportsplex #2", 
                                        "Evergreen Sportsplex #3", 
                                        "Evergreen Sportsplex #4"), 
                         field.address = c(rep("4830 Riverside Parkway, Ashburn, VA 20147", 2), 
                                           rep("19623 Evergreen Mill Road, Leesburg, VA", 4)))

## Annandale United FC
aufc <- data.frame(club.name = rep("Annandale United FC", 4), 
                   field.name = c("Annandale HS Stadium", 
                                  "Annandale HS Track turf field", 
                                  "Mason District Park #3 Front Turf", 
                                  "Pine Ridge Park #4"),
                   field.address = c(rep("4700 Medford Dr, Annandale, VA 22003",2), 
                                     "6621 Columbia Pike, Annandale, VA 22003", 
                                     "3401 Woodburn Rd, Annandale, VA 22003"))

## Maryland United FC
mufc <- read_html("http://www.mdunitedfc.org/facilities/playing-locations") %>% 
        html_node("div.dii-content-story table") %>% 
        html_table(fill = TRUE)
mufc <- mufc[-c(1,2),-c(3:5)]
names(mufc) <- c("field.name", "field.address")
mufc$club.name <- rep("Maryland United FC", 20)
mufc <- mufc[,c(3,1,2)]
mufc[8,3] <- "2001 Church Rd, Bowie, MD 20721"

## Ellicott City Soccer Club
ecsc <- data.frame(club.name = "Ellicott City Soccer Club",
                   field.name = "Chapelgate Christian Academy",
                   field.address = "2600 Marriottsville Road, Marriottsville, MD 21104")

## Prince William Courage
pwsi <- data.frame(club.name = rep("Prince William Courage", 6))
pwsi$field.name <- read_html("http://www.pwsi.org/Default.aspx?tabid=546279") %>% 
        html_nodes("div.fs-right h3.fs-name") %>% 
        html_text()
pwsi$field.address <- read_html("http://www.pwsi.org/Default.aspx?tabid=546279") %>% 
        html_nodes("div.fs-right p.fs-address") %>% 
        html_text()
pw.fields <- fields.df[c(289:297),c(1:3)]
pwsi <- rbind(pwsi, pw.fields)
pwsi <- pwsi[-c(1:3),]
pwsi$club.name <- gsub("Prince William Soccer Club", "Prince William Courage", pwsi$club.name)
pwsi[1,3] <- "1650 Prince William Parkway, Woodbridge, VA 22191"
pwsi[2,3] <- "5070 Dale Blvd, Woodbridge, VA 22193"
pwsi[3,3] <- "2201 York Dr, Woodbridge, VA 22191"

## Pasadena Soccer Club
pasadena <- data.frame(club.name = rep("Pasadena Soccer Club", 11),
                       field.name = c("Lake Shore Athletic Complex A",
                                      "Lake Shore Athletic Complex B",
                                      "Lake Shore Athletic Complex C",
                                      "Lake Shore Athletic Complex D",
                                      "Riviera Beach Community Park",
                                      "Muth Field",
                                      "Tick Neck Park #1",
                                      "Tick Neck Park #2",
                                      "Tick Neck Park #3",
                                      "Rock Creek Park",
                                      "Jacobsville Recreation Area"),
                       field.address = c(rep("850 Woods Road, Pasadena, MD 21122", 4),
                                         "131 Meadow Rd, Pasadena, MD 21122",
                                         "8513 St Jane Dr, Pasadena, MD 21122",
                                         rep("7750 Edwin Raynor Blvd, Pasadena, MD 21122", 3),
                                         "79 Bar Harbor Rd, Pasadena, MD 21122",
                                         "64 Magothy Beach Rd, Pasadena, MD 21122"))

fields.df <- rbind(fields.df, fcv.united, aufc, mufc, ecsc, pwsi, pasadena)
rownames(fields.df) <- 1:nrow(fields.df)
```

Using the `{RDSTK}` package, I translated each field address to a set of coordinates.

```{r translate.coordinates}
library(RDSTK)

lats.longs <- do.call(rbind, lapply(fields.df$field.address, street2coordinates))
fields.df$lat <- lats.longs$latitude ; fields.df$lng <- lats.longs$longitude
```

Then, using functions from the `{dplyr}` package, I calculated the geographic center of each club's field locations. All field coordinates were weighted equally, including those clustered together in parks or other recreation areas.

*Note: I want to acknowledge that weighting each field location by the number of games played there over the course of the season may have resulted in a more accurate depiction of where clubs play their soccer, "on average." However, given what little difference this weighting was likely to make, I determined it was not worth the hours it would take to also scrape game data off NCSL's antiquated website.*

```{r calc.geocenters}
clubs <- fields.df %>% 
        group_by(club.name) %>% 
        dplyr::summarize(lat = mean(lat), lng = mean(lng))
```

And finally, I cleaned up the messy club names.

```{r clean.clubnames}
clubs[1,1] <- "A3 Soccer"
clubs[10,1] <- "Barca Futebol Clube"
clubs[17,1] <- "Capital FC"
clubs[29,1] <- "FSV Ashburn"
clubs[50,1] <- "Olney Boys & Girls Club"
```

The first few rows of the clubs data frame look like this.

```{r preview.clubstable, echo = FALSE, results = "asis"}
library(pander)
pandoc.table(head(clubs), justify = "left")
```

## Clubs and the Communities They Serve

To put the locations of the clubs in context, I used the `{acs}` package to gather data on race and poverty (at the census tract level) from the U.S. Census Bureau's 2015 [American Community Survey](https://www.census.gov/programs-surveys/acs/) (ACS). I also used the `{tigris}` package to collect shape files for each census tract.

Using the table of coordinates generated by the `street2coordinates` function, I identified the codes of each county for which I would need to gather census data.

```{r save.counties.tracts}
library(tigris)

## County fips numbers
counties.md <- c(3, 21, 43, 31, 9, 33, 17, 27, 37)
counties.va <- c(510, 13, 59, 600, 47, 107, 630, 187, 683, 685, 153, 610, 179, 61, 840, 69, 43, 177)
counties.dc <- 1
counties.wv <- c(37, 3)

## Pull shapefiles for each state and combine
tracts.md <- tracts("MD", counties.md, cb = TRUE)
tracts.va <- tracts("VA", counties.va, cb = TRUE)
tracts.dc <- tracts("DC", counties.dc, cb = TRUE)
tracts.wv <- tracts("WV", counties.wv, cb = TRUE)
tracts.total <- rbind(tracts.md, tracts.va, tracts.dc, tracts.wv)
```

### Race

After building a function that pulls the necessary data on race from the ACS, I ran it on each state's counties and combined those results into a single data frame. (Credit to [ZevRoss](http://zevross.com/blog/2015/10/14/manipulating-and-mapping-us-census-data-in-r-using-the-acs-tigris-and-leaflet-packages-3/#interactive-plotting-with-the-leaflet-package-not-leafletr) for some guidance here.)

```{r gather.racedata}
library(acs)
library(stringr)

## Function that will pull race stats for each state's tracts
pullRace <- function(state, counties) {
        geo <- geo.make(state = state, county = counties, tract = "*")
        race <- acs.fetch(2015, 5, geo, table.number = "B02001", col.names = "pretty")
        df <- data.frame(paste0(str_pad(race@geography$state, 2, "left", pad="0"), 
                                   str_pad(race@geography$county, 3, "left", pad="0"),
                                   str_pad(race@geography$tract, 6, "left", pad="0")),
                            race@estimate[,c("Race: Total:", "Race: White alone")],
                            stringsAsFactors = FALSE)
        rownames(df) <- 1:nrow(df)
        names(df) <- c("GEOID", "total", "white")
        df$nonwhite.perc <- (1-(df$white/df$total))
        df
}

## Run race function for each state and combine
race.md <- pullRace("MD", counties.md)
race.va <- pullRace("VA", counties.va)
race.dc <- pullRace("DC", counties.dc)
race.wv <- pullRace("WV", counties.wv)
race.total <- rbind(race.md, race.va, race.dc, race.wv)
```

To place all of that information on a Leaflet map, I combined the data frame and shape files using the `geo_join` function.

```{r leaflet.race, results = "asis"}
library(leaflet)

## Join data frames and shapefiles
race.tracts <- geo_join(tracts.total, race.total, "GEOID", "GEOID")
race.tracts$nonwhite.perc <- race.tracts$nonwhite.perc*100

## Set color palette for map
pal1 <- colorBin("Greys", race.tracts$nonwhite.perc, 8, na.color = NA)

## Leaflet map settings
clubs %>% leaflet() %>%
        addProviderTiles("CartoDB.Positron") %>%
        addPolygons(data = race.tracts, 
                    fillColor = ~pal1(nonwhite.perc), 
                    color = "#b2aeae",
                    fillOpacity = 0.7, 
                    weight = 0.5, 
                    smoothFactor = 0.2) %>%
        addCircleMarkers(weight = 0, 
                         radius = 3,
                         fillColor = "#ff7256",
                         fillOpacity = 0.9, 
                         popup = clubs$club.name) %>% 
        addLegend(title = "Share of Nonwhite Residents",
                  pal = pal1, 
                  values = race.tracts$nonwhite.perc, 
                  position = "bottomleft", 
                  labFormat = labelFormat(suffix = "%"))
```

This map already paints a pretty clear picture, particularly in the areas to the southeast of D.C. proper. But to look at it another way, I chose to plot a histogram of the density of soccer fields by their corresponding census tract data.

To do so, I removed duplicate soccer fields (i.e., instances in which multiple clubs share a single field) using the `distinct` function. And using the `append_geoid` function, I translated the coordinates of each field location to an eleven-digit code which corresponds with a census tract (GEOID).

```{r unique.fields}
library(censusr)

## Reshape fields table
fields.unique <- fields.df %>% 
        distinct(field.name, .keep_all = TRUE)
names(fields.unique)[5] <- "lon"

## Match GEOIDs
fields.unique$GEOID <- append_geoid(fields.unique[,c(4:5)])[,3]
fields.unique$GEOID <- strtrim(fields.unique$GEOID, 11)
```

In order to match the soccer fields to the census data in a single table for `ggplot`, I first created a reference table, and then used the `merge` function.

```{r histogram.race, results = "asis"}
library(ggplot2)

## Create lookup table
race.lookup <- race.total[,c(1,4)]

## Fill in race for each field's census tract
fields.unique <- merge(fields.unique, race.lookup, by = "GEOID")

## Build histogram
ggplot(fields.unique, aes(nonwhite.perc)) +
        geom_histogram(binwidth = 0.05, fill = "coral1") +
        theme_TCR() +
        scale_x_continuous(labels = scales::percent) +
        scale_y_continuous(expand = c(0,0)) +
        xlab("Share of Nonwhite Residents") + ylab("Number of Fields")
```

Again, a clear pattern emerges. Out of the 380 soccer fields in the sample, less than 15 percent are located in majority-minority census tracts. (For reference, out of the 1,600 census tracts in the sample, 32 percent are majority-minority. I've also plotted that histogram below.)

```{r calc.fieldraceproportions}
sum(fields.unique$nonwhite.perc > 0.5)/nrow(fields.unique)
```

```{r histogram.tracts.race, echo = FALSE, results = "asis"}
ggplot(race.lookup, aes(nonwhite.perc)) +
        geom_histogram(binwidth = 0.05, fill = "coral1") +
        theme_TCR() +
        scale_x_continuous(labels = scales::percent) +
        scale_y_continuous(expand = c(0,0)) +
        xlab("Share of Nonwhite Residents") + ylab("Number of Census Tracts")
```

### Poverty

To gather information on poverty rates, I similarly built a function that pulls those data from ACS.

```{r gather.povertydata}
## Function that will pull poverty stats for each state's tracts
pullPoverty <- function(state, counties) {
        geo <- geo.make(state = state, county = counties, tract = "*")
        poverty <- acs.fetch(2015, 5, geo, table.number = "C17002", col.names = "pretty")
        df <- data.frame(paste0(str_pad(poverty@geography$state, 2, "left", pad="0"), 
                                str_pad(poverty@geography$county, 3, "left", pad="0"),
                                str_pad(poverty@geography$tract, 6, "left", pad="0")),
                         poverty@estimate[,c("Ratio of Income to Poverty Level in the Past 12 Months: Total:", 
                                             "Ratio of Income to Poverty Level in the Past 12 Months: Under .50",
                                             "Ratio of Income to Poverty Level in the Past 12 Months: .50 to .99")],
                         stringsAsFactors = FALSE)
        rownames(df) <- 1:nrow(df)
        names(df) <- c("GEOID", "total", "poverty1", "poverty2")
        df$poverty.rate <- (df$poverty1 + df$poverty2) / df$total
        df
}

## Run poverty function for each state and combine
poverty.md <- pullPoverty("MD", counties.md)
poverty.va <- pullPoverty("VA", counties.va)
poverty.dc <- pullPoverty("DC", counties.dc)
poverty.wv <- pullPoverty("WV", counties.wv)
poverty.total <- rbind(poverty.md, poverty.va, poverty.dc, poverty.wv)
```

To place all of that information on a Leaflet map, I combined the data frame and shape files using the `geo_join` function.

```{r leaflet.poverty, results = "asis"}
## Join data frames and shapefiles
poverty.tracts <- geo_join(tracts.total, poverty.total, "GEOID", "GEOID")
poverty.tracts$poverty.rate <- poverty.tracts$poverty.rate*100
poverty.tracts$poverty.bins <- cut(poverty.tracts$poverty.rate, 
                                   breaks = c(-1, 10, 20, 30, 40, 100), 
                                   labels = c("Less than 10%", "10 - 20%", "20 - 30%", "30 - 40%", "More than 40%"))

## Set color palette for map
pal2 <- colorFactor("Greys", poverty.tracts$poverty.bins, na.color = NA)

## Leaflet map settings
clubs %>% leaflet() %>%
        addProviderTiles("CartoDB.Positron") %>%
        addPolygons(data = poverty.tracts, 
                    fillColor = ~pal2(poverty.bins), 
                    color = "#b2aeae",
                    fillOpacity = 0.7, 
                    weight = 0.5, 
                    smoothFactor = 0.2) %>%
        addCircleMarkers(weight = 0, 
                         radius = 3,
                         fillColor = "#ff7256",
                         fillOpacity = 0.9, 
                         popup = clubs$club.name) %>% 
       addLegend(title = "Share of Residents<br>Below the Poverty Line",
                 pal = pal2, 
                 values = poverty.tracts$poverty.bins, 
                 position = "bottomleft")
```

Again, to view the data in another way, I chose to plot a histogram of the density of soccer fields by their corresponding census tract data. In order to match them to the census data in a single table for `ggplot`, I first created a reference table, and then used the `merge` function.

```{r histogram.poverty, results = "asis"}
## Create lookup table
poverty.lookup <- poverty.total[,c(1,5)]

## Fill in race for each field's census tract
fields.unique <- merge(fields.unique, poverty.lookup, by = "GEOID")

## Build histogram
ggplot(fields.unique, aes(poverty.rate)) +
        geom_histogram(binwidth = 0.05, fill = "coral1") +
        theme_TCR() +
        scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +
        scale_y_continuous(expand = c(0,0)) +
        xlab("Share of Residents Living Below the Poverty Line") + 
        ylab("Number of Fields")
```

Out of the 380 soccer fields in the sample, *just one* is located in a census tract with a poverty rate greater than 20 percent. (For reference, out of the 1,600 census tracts in the sample, 15 percent have poverty rates greater than 20 percent. I've also plotted that histogram below.)

```{r calc.fieldpovertyproportions}
sum(fields.unique$poverty.rate > 0.2, na.rm = TRUE)
```

```{r histogram.tracts.poverty, echo = FALSE, results = "asis"}
ggplot(poverty.lookup, aes(poverty.rate)) +
        geom_histogram(binwidth = 0.05, fill = "coral1") +
        theme_TCR() +
        scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +
        scale_y_continuous(expand = c(0,0)) +
        xlab("Share of Residents Living Below the Poverty Line") + 
        ylab("Number of Census Tracts")
```